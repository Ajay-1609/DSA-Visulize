pipeline {
    agent any

    environment {
        IMAGE_NAME = "dsa-visualization"
        IMAGE_TAG = "${env.BUILD_NUMBER}"

        // Nexus Private Docker Registry
        REGISTRY_URL = "http://nexus.imcc.com:8089"
        REGISTRY_REPO = "2401003" // Your uploaded hosted repo
    }

    stages {

        stage('Checkout Code') {
            steps {
                git 'https://github.com/VivekKamble014/DSA-Visualization.git'
            }
        }

        stage('Install Dependencies & Build') {
            steps {
                dir('client') {
                    sh 'npm install'
                    sh 'npm run build'
                }
            }
        }

        stage('SonarQube Code Scan') {
            steps {
                script {
                    withSonarQubeEnv('sonarqube.imcc.com') {
                        sh """
                        sonar-scanner \
                        -Dsonar.projectKey=${IMAGE_NAME} \
                        -Dsonar.sources=client/src \
                        -Dsonar.host.url=http://sonarqube.imcc.com \
                        -Dsonar.login=$SONAR_TOKEN
                        """
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    dir('client') {
                        sh "docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ."
                        sh "docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${REGISTRY_URL}/repository/${REGISTRY_REPO}/${IMAGE_NAME}:${IMAGE_TAG}"
                    }
                }
            }
        }

        stage('Push to Nexus Private Registry') {
            steps {
                script {
                    docker.withRegistry("${REGISTRY_URL}/repository/${REGISTRY_REPO}", "nexus-credentials") {
                        sh "docker push ${REGISTRY_URL}/repository/${REGISTRY_REPO}/${IMAGE_NAME}:${IMAGE_TAG}"
                    }
                }
            }
        }

        stage('Deploy Container') {
            steps {
                script {
                    sh """
                    docker stop dsa-container || true
                    docker rm dsa-container || true
                    docker run -d -p 80:80 --name dsa-container \
                    ${REGISTRY_URL}/repository/${REGISTRY_REPO}/${IMAGE_NAME}:${IMAGE_TAG}
                    """
                }
            }
        }
    }

    post {
        success {
            echo "üöÄ Deployment Successful at port 80!"
        }
        failure {
            echo "‚ùå Pipeline Failed ‚Äî Check logs!"
        }
    }
}
