pipeline {
  agent any

  environment {
    // Name of your SonarQube installation in Jenkins → configure in Manage Jenkins → Global Tool Configuration
    SONARQUBE = 'IMCC-Sonar'  
    DOCKER_IMAGE = "my-react-app:${env.BUILD_NUMBER}"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Install & Build') {
      steps {
        dir('client') {
          sh 'npm ci'
          sh 'npm run build'
        }
      }
    }

    stage('SonarQube Analysis') {
      steps {
        withSonarQubeEnv("${SONARQUBE}") {
          sh "sonar-scanner -Dsonar.projectKey=dsa-client -Dsonar.sources=client/src -Dsonar.host.url=http://sonarqube.imcc.com -Dsonar.login=${SONAR_TOKEN}"
        }
      }
    }

    stage('Wait for Quality Gate') {
      steps {
        timeout(time: 5, unit: 'MINUTES') {
          waitForQualityGate abortPipeline: true
        }
      }
    }

    stage('Docker Build & Push') {
      steps {
        dir('client') {
          sh "docker build -t ${DOCKER_IMAGE} ."
        }
        // Optionally: push to a registry
        // sh "docker push ${DOCKER_IMAGE}"
      }
    }

    // Optional: deployment stage (if you deploy somewhere)
    stage('Deploy') {
      steps {
        echo "Deploy stage — add your deploy commands here"
      }
    }
  }

  post {
    always {
      cleanWs()
    }
  }
}